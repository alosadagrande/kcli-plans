parameters:
 prefix: karim
 numcpus: 4
 network: default
 use_br: false
 extra_disk: false
 master_memory: 8192
 worker_memory: 8192
 bootstrap_memory: 4096
 haproxy_memory: 2048
 haproxy_bootstrap: true
 disk_size: 30
 extra_disk_size: 30
 template: rhcos-410.8.20190520.1-qemu.qcow2
 haproxy_template: CentOS-7-x86_64-GenericCloud.qcow2
 cluster: testk
 domain: karmalabs.com
 masters: 1
 workers: 0
 haproxy_ip: 
 haproxy_mac: 
 bootstrap_ip: 
 bootstrap_mac: 
 masters_ips: []
 masters_macs: []
 workers_ips: []
 workers_macs: []

{% for num in range(0, masters) %}
{{ prefix }}-master-{{ num }}:
 domain: {{ cluster }}.{{ domain }} 
 template: {{ template }}
 numcpus: {{ numcpus }}
 memory: {{ master_memory }}
{% if haproxy_ip != '' %}
 dns: {{ haproxy_ip }}
{% endif %}
 nets:
  - name: {{ network }}
{% if masters_ips %}
    ip: {{ masters_ips[num] }}
{% endif %}
{% if masters_macs %}
    mac: {{ masters_macs[num] }}
{% else %}
 reservedns: true
{% endif %}
 disks:
  - size: {{ disk_size }}
{% if use_br %}
 files:
  - path: /etc/NetworkManager/dispatcher.d/98-brextscript
    origin: 98-brextscript
    mode: 755
  - path: /etc/sysconfig/network-scripts/ifcfg-brext
    origin: ifcfg-brext
{% endif %}
{% endfor %}

{% for num in range(0, workers) %}
{{ prefix }}-worker-{{ num }}:
 domain: {{ cluster }}.{{ domain }} 
 template: {{ template }}
 numcpus: {{ numcpus }}
 memory: {{ worker_memory }}
{% if haproxy_ip != '' %}
 dns: {{ haproxy_ip }}
{% endif %}
 nets:
  - name: {{ network }}
{% if workers_ips %}
    ip: {{ workers_ips[num] }}
{% endif %}
{% if workers_macs %}
    mac: {{ workers_macs[num] }}
{% else %}
 reservedns: true
{% endif %}
 disks:
  - size: {{ disk_size }}
{% if extra_disk %}
  - size: {{ extra_disk_size }}
{% endif %}
{% if use_br %}
 files:
  - path: /etc/NetworkManager/dispatcher.d/98-brextscript
    origin: 98-brextscript
  - path: /etc/sysconfig/network-scripts/ifcfg-brext
    origin: ifcfg-brext
{% endif %}
{% endfor %}

{{ prefix }}-bootstrap:
 template: {{ template }}
 numcpus: 2
 memory: {{ bootstrap_memory }}
{% if haproxy_ip != '' %}
 dns: {{ haproxy_ip }}
{% endif %}
 nets:
  - name: {{ network }}
{% if bootstrap_ip != '' %}
    ip: {{ bootstrap_ip }}
{% endif %}
{% if bootstrap_mac != '' %}
    mac: {{ bootstrap_mac }}
{% else %}
 reservedns: true
{% endif %}
 disks:
  - size: {{ disk_size }}

{{ prefix }}-haproxy:
 template: {{ haproxy_template }}
 numcpus: 2
 memory: {{ haproxy_memory }}
 nets:
  - name: {{ network }}
{% if haproxy_mac != '' %}
    mac: {{ haproxy_mac }}
{% else %}
 reservedns: true
{% endif %}
 disks:
  - size: 10
 files:
  - path: /etc/hosts
    origin: hosts
    mode: 644
  - haproxy.cfg
{% if haproxy_bootstrap %}
  - path: /root/bootstrap.ign
    origin: {{ cluster }}/bootstrap.ign.ori
    mode: 644
{% endif %}
 scripts:
  - haproxy.sh
  - dnsmasq.sh
{% if haproxy_bootstrap %}
  - ignitionbootstrap.sh
{% endif %}
  - ignitionfiles.sh
