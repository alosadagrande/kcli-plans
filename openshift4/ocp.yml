parameters:
 numcpus: 4
 network: default
 use_br: false
 extra_disk: false
 master_memory: 8192
 worker_memory: 8192
 deploy_bootstrap: true
 bootstrap_memory: 4096
 disk_size: 30
 extra_disk_size: 30
 template: rhcos-410.8.20190520.1-openstack.qcow2
 cluster: testk
 domain: karmalabs.com
 masters: 1
 workers: 0
 helper_ip: 
 helper_mac: 
 bootstrap_ip: 
 bootstrap_mac: 
 masters_ips: []
 masters_macs: []
 workers_ips: []
 workers_macs: []

{% if deploy_bootstrap %}
{{ cluster }}-bootstrap:
 template: {{ template }}
 numcpus: 2
 memory: {{ bootstrap_memory }}
 dns: {{ helper_ip }}
 nets:
  - name: {{ network }}
    ip: {{ bootstrap_ip }}
    mac: {{ bootstrap_mac }}
 disks:
  - size: {{ disk_size }}
 files:
  - path: /etc/kubernetes/manifests/dnsmasq.yml
    origin: staticpods/dnsmasq.yml
  - path: /etc/kubernetes/dnsmasq.conf
    origin: dnsmasq.conf
  - path: /etc/kubernetes/manifests/keepalived.yml
    origin: staticpods/keepalived.yml
  - path: /etc/kubernetes/keepalived.conf
    origin: keepalived.conf
  - path: /etc/kubernetes/manifests/nginx.yml
    origin: staticpods/nginx.yml
{% endif %}

{% for num in range(0, masters) %}
{{ cluster }}-master-{{ num }}:
 domain: {{ cluster }}.{{ domain }} 
 template: {{ template }}
 numcpus: {{ numcpus }}
 memory: {{ master_memory }}
 dns: {{ helper_ip }}
 nets:
  - name: {{ network }}
    ip: {{ masters_ips[num] }}
    mac: {{ masters_macs[num] }}
 disks:
  - size: {{ disk_size }}
{% if use_br %}
 files:
  - path: /etc/NetworkManager/dispatcher.d/98-brextscript
    origin: 98-brextscript
    mode: 755
  - path: /etc/sysconfig/network-scripts/ifcfg-brext
    origin: ifcfg-brext
  - path: /etc/kubernetes/manifests/dnsmasq.yml
    origin: staticpods/dnsmasq.yml
  - path: /etc/kubernetes/dnsmasq.conf
    origin: dnsmasq.conf
{% if workers > 0 %}
  - path: /etc/kubernetes/manifests/haproxy.yml
    origin: staticpods/haproxy.yml
  - path: /etc/kubernetes/haproxy.cfg
    origin: haproxy.cfg
  - path: /etc/sysctl.d/nonlocalbind.conf
    origin: nonlocalbind.conf
{% endif %}
  - path: /etc/kubernetes/manifests/keepalived.yml
    origin: staticpods/keepalived.yml
  - path: /etc/kubernetes/keepalived.conf
    origin: keepalived.conf
{% endif %}
{% endfor %}

{% for num in range(0, workers) %}
{{ cluster }}-worker-{{ num }}:
 domain: {{ cluster }}.{{ domain }} 
 template: {{ template }}
 numcpus: {{ numcpus }}
 memory: {{ worker_memory }}
 dns: {{ helper_ip }}
 nets:
  - name: {{ network }}
    ip: {{ workers_ips[num] }}
    mac: {{ workers_macs[num] }}
 disks:
  - size: {{ disk_size }}
{% if extra_disk %}
  - size: {{ extra_disk_size }}
{% endif %}
{% if use_br %}
 files:
  - path: /etc/NetworkManager/dispatcher.d/98-brextscript
    origin: 98-brextscript
    mode: 755
  - path: /etc/sysconfig/network-scripts/ifcfg-brext
    origin: ifcfg-brext
{% endif %}
{% endfor %}
